@page "/AverageCityTemperatures"
@using System.Diagnostics
@inject HttpClient HttpClient

<!-- KristofferStrube.Blazor.WebWorkers -->
@using KristofferStrube.Blazor.DOM
@using KristofferStrube.Blazor.WebWorkers
@using KristofferStrube.Blazor.Window
@inject IJSRuntime JSRuntime

<!-- Tewr.BlazorWorker -->
@using BlazorWorker.BackgroundServiceFactory
@using BlazorWorker.Core
@inject IWorkerFactory workerFactory

<!-- SpawnDev.BlazorJS.WebWorkers -->
@using SpawnDev.BlazorJS.WebWorkers
@inject WebWorkerService WebWorkerService

<PageTitle>Workers Benchmarks - Average City Temperatures</PageTitle>

<h1>Average City Temperatures</h1>

<p>
    Here we compare how quick a worker can fetch information about temperate measurements and calcualte each city's min, max, and average temperatures using three different implementations of a Worker Wrapper.
</p>

<p>
    <label for="rounds">Rounds</label>
    <input type="number" id="rounds" @bind=rounds>
</p>

<p>
    <label for="input">Input</label>
    <input type="number" id="input" @bind=input>
</p>

<p>
    <label for="skipPart">Skip</label>
    <input type="number" id="skipPart" @bind=skipPart>
</p>

<button class="btn btn-primary" @onclick=MeasureMainThread>Measure Average running on main thread</button>

@if (averageMainThread is not null)
{
    <text>
        &nbsp;
        <span class="badge bg-primary">@Math.Round((decimal)averageMainThread, 3)</span> milliseconds
    </text>
}
<br />
<br />

<button class="btn btn-primary" @onclick=MeasureJSWebWorkers>Measure Average JS Web Workers</button>

@if (averageJSWebWorkers is not null)
{
    <text>
        &nbsp;
        <span class="badge bg-primary">@Math.Round((decimal)averageJSWebWorkers, 3)</span> milliseconds
    </text>
}
<br />
<br />

<button class="btn btn-primary" @onclick=MeasureBlazorWebWorkers>Measure Average KristofferStrube.Blazor.WebWorkers</button>

@if (averageKristofferStrubeBlazorWebWorkers is not null)
{
    <text>
        &nbsp;
        <span class="badge bg-primary">@Math.Round((decimal)averageKristofferStrubeBlazorWebWorkers, 3)</span> milliseconds
    </text>
}
<br />
<br />

<button class="btn btn-primary" @onclick=MeasureTewrBlazorWorker>Measure Average Tewr.BlazorWorker</button>

@if (averageTewrBlazorWorker is not null)
{
    <text>
        &nbsp;
        <span class="badge bg-primary">@Math.Round((decimal)averageTewrBlazorWorker, 3)</span> milliseconds
    </text>
}
<br />
<br />

<button class="btn btn-primary" @onclick=MeasureSpawnDevBlazorJSWebWorkers>Measure Average SpawnDev.BlazorJS.WebWorkers</button>

@if (averageSpawnDevBlazorJSWebWorkers is not null)
{
    <text>
        &nbsp;
        <span class="badge bg-primary">@Math.Round((decimal)averageSpawnDevBlazorJSWebWorkers, 3)</span> milliseconds
    </text>
}
<br />
<br />

@code {
    int rounds = 100;
    int input = 1000;
    double skipPart = 0.9;

    double? averageMainThread = null;
    double? averageJSWebWorkers = null;
    double? averageKristofferStrubeBlazorWebWorkers = null;
    double? averageTewrBlazorWorker = null;
    double? averageSpawnDevBlazorJSWebWorkers = null;

    public async Task MeasureMainThread()
    {
        averageMainThread = null;
        StateHasChanged();

        AverageCityTemperaturesJob job = new(HttpClient);

        List<double> measurements = new();
        for (int i = 0; i < rounds; i++)
        {
            long start = Stopwatch.GetTimestamp();
            await job.Work(input);
            measurements.Add(Stopwatch.GetElapsedTime(start).TotalMilliseconds);
        }

        averageMainThread = measurements
            .OrderDescending()
            .Skip((int)(rounds * skipPart))
            .Average();
    }

    public async Task MeasureJSWebWorkers()
    {
        long start = 0;
        averageJSWebWorkers = null;
        StateHasChanged();

        var jsWorker = await Worker.CreateAsync(JSRuntime, "averageCityTemperatures.js");

        List<double> measurements = new();
        int i = 0;

        EventListener<MessageEvent> eventListener = default!;
        eventListener = await EventListener<MessageEvent>.CreateAsync(JSRuntime, async e =>
        {
            i++;
            var result = await e.GetDataAsync<CityStatistics[]>();
            measurements.Add(Stopwatch.GetElapsedTime(start).TotalMilliseconds);
            if (i < rounds)
            {
                start = Stopwatch.GetTimestamp();
                await jsWorker.PostMessageAsync(input);
            }
            else
            {
                await jsWorker.RemoveOnMessageEventListenerAsync(eventListener);
                await eventListener.DisposeAsync();

                averageJSWebWorkers = measurements
                    .OrderDescending()
                    .Skip((int)(rounds * skipPart))
                    .Average();
                StateHasChanged();
            }
        });

        await jsWorker.AddOnMessageEventListenerAsync(eventListener);

        start = Stopwatch.GetTimestamp();
        await jsWorker.PostMessageAsync(input);
    }

    public async Task MeasureBlazorWebWorkers()
    {
        averageKristofferStrubeBlazorWebWorkers = null;
        StateHasChanged();

        var jobWorker = await JobWorker<int, CityStatistics[], AverageCityTemperaturesJob>.CreateAsync(JSRuntime);

        List<double> measurements = new();
        for (int i = 0; i < rounds; i++)
        {
            long start = Stopwatch.GetTimestamp();
            await jobWorker.ExecuteAsync(input);
            measurements.Add(Stopwatch.GetElapsedTime(start).TotalMilliseconds);
        }

        averageKristofferStrubeBlazorWebWorkers = measurements
            .OrderDescending()
            .Skip((int)(rounds * skipPart))
            .Average();
    }

    public async Task MeasureTewrBlazorWorker()
    {
        averageTewrBlazorWorker = null;
        StateHasChanged();

        var worker = await workerFactory.CreateAsync();
        var service = await worker.CreateBackgroundServiceAsync<AverageCityTemperaturesJob>();

        List<double> measurements = new();
        for (int i = 0; i < rounds; i++)
        {
            long start = Stopwatch.GetTimestamp();
            var localParameterValue = input;
            await service.RunAsync(s => s.Work(localParameterValue));
            measurements.Add(Stopwatch.GetElapsedTime(start).TotalMilliseconds);
        }

        averageTewrBlazorWorker = measurements
            .OrderDescending()
            .Skip((int)(rounds * skipPart))
            .Average();
    }

    public async Task MeasureSpawnDevBlazorJSWebWorkers()
    {
        averageSpawnDevBlazorJSWebWorkers = null;
        StateHasChanged();

        var worker = await WebWorkerService.GetWebWorker();

        List<double> measurements = new();
        for (int i = 0; i < rounds; i++)
        {
            long start = Stopwatch.GetTimestamp();
            await worker!.Run<AverageCityTemperaturesJob, CityStatistics[]>(job => job.Work(input));
            measurements.Add(Stopwatch.GetElapsedTime(start).TotalMilliseconds);
        }

        averageSpawnDevBlazorJSWebWorkers = measurements
            .OrderDescending()
            .Skip((int)(rounds * skipPart))
            .Average();
    }
}